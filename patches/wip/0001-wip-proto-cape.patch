From ba7f45bb6d2e396e05adbc446fbd4a4d615a62e0 Mon Sep 17 00:00:00 2001
From: Robert Nelson <robertcnelson@gmail.com>
Date: Mon, 27 Jan 2014 16:46:13 -0600
Subject: [PATCH] wip: proto cape

Signed-off-by: Robert Nelson <robertcnelson@gmail.com>
---
 arch/arm/boot/dts/am335x-bone-common.dtsi |  11 +++
 firmware/Makefile                         |   1 +
 firmware/capes/cape-bone-proto-00A0.dts   | 140 ++++++++++++++++++++++++++++++
 3 files changed, 152 insertions(+)
 create mode 100644 firmware/capes/cape-bone-proto-00A0.dts

diff --git a/arch/arm/boot/dts/am335x-bone-common.dtsi b/arch/arm/boot/dts/am335x-bone-common.dtsi
index c401870..bf419b4 100644
--- a/arch/arm/boot/dts/am335x-bone-common.dtsi
+++ b/arch/arm/boot/dts/am335x-bone-common.dtsi
@@ -244,6 +244,17 @@
 				part-number = "BB-BONELT-HDMIN";
 			};
 
+			/* New Default PinMux: http://elinux.org/CircuitCo:Basic_Proto_Cape */
+			slot@103 {
+				ti,cape-override;
+				priority = <1>;
+				compatible = "ti,beaglebone", "ti,beaglebone-black";
+				board-name = "BB-BASIC-PROTO";
+				version = "00A0";
+				manufacturer = "CircuitCo";
+				part-number = "cape-bone-proto";
+			};
+
 		};
 
 		/* mapping between board names and dtb objects */
diff --git a/firmware/Makefile b/firmware/Makefile
index e45d10b..ecc54d9 100644
--- a/firmware/Makefile
+++ b/firmware/Makefile
@@ -191,6 +191,7 @@ fw-shipped-$(CONFIG_CAPE_BEAGLEBONE) += \
 	BB-BONE-CAM3-01-00A2.dtbo \
 	BB-BONE-CAM-VVDN-00A0.dtbo \
 	TT3201-001-01.dtbo \
+	cape-bone-proto-00A0.dtbo \
 	BB-BONE-SERL-03-00A1.dtbo \
 	BB-BONE-BACON-00A0.dtbo \
 	BB-BONE-BACONE-00A0.dtbo \
diff --git a/firmware/capes/cape-bone-proto-00A0.dts b/firmware/capes/cape-bone-proto-00A0.dts
new file mode 100644
index 0000000..d5cfa6c
--- /dev/null
+++ b/firmware/capes/cape-bone-proto-00A0.dts
@@ -0,0 +1,140 @@
+/*
+ * Copyright (C) 2014 Robert Nelson <robertcnelson@gmail.com>
+ *
+ * Virtual cape http://elinux.org/CircuitCo:Basic_Proto_Cape
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ */
+/dts-v1/;
+/plugin/;
+
+/ {
+	compatible = "ti,beaglebone", "ti,beaglebone-black";
+
+	/* identification */
+	part-number = "basic-proto";
+	version = "00A0";
+
+	/* state the resources this cape uses */
+	exclusive-use =
+		/* the pin header uses */
+		/* spi0 */
+		"P9.17",	/* spi0_cs0 */
+		"P9.18",	/* spi0_d1 */
+		"P9.21",	/* spi0_d0 */
+		"P9.22",	/* spi0_sclk */
+		/* uart 1 */
+		"P9.24",	/* uart1_txd */
+		"P9.26",	/* uart1_rxd */
+		/* adc */
+		"P9.33",	/* AIN4 */
+		"P9.36",	/* AIN5 */
+		"P9.35",	/* AIN6 */
+		/* the hardware ip uses */
+		"spi0",
+		"tscadc",
+		"uart1";
+
+	fragment@0 {
+		target = <&am33xx_pinmux>;
+		__overlay__ {
+
+			//FIXME: default input/output?
+			//gpio_helper_pins: pinmux_gpio_helper_pins {
+			//	pinctrl-single,pins = <
+			//		0x000 0x00	/* P9 28 GPIO0_22: */
+			//		0x000 0x00	/* P9 27 GPIO1_26: */
+			//		0x000 0x00	/* P9 28 GPIO2_2: */
+			//		0x000 0x00	/* P9 28 GPIO2_3: */
+			//		0x000 0x00	/* P9 28 GPIO2_4: */
+			//		0x000 0x00	/* P9 28 GPIO2_5: */
+			//	>;
+			//};
+
+			bb_spi0_pins: pinmux_bb_spi0_pins {
+				pinctrl-single,pins = <
+					0x150 0x30	/* spi0_sclk.spi0_sclk, INPUT_PULLUP | MODE0 */
+					0x154 0x30	/* spi0_d0.spi0_d0, INPUT_PULLUP | MODE0 */
+					0x158 0x10	/* spi0_d1.spi0_d1, OUTPUT_PULLUP | MODE0 */
+					0x15c 0x10	/* spi0_cs0.spi0_cs0, OUTPUT_PULLUP | MODE0 */
+				>;
+			};
+
+			bb_uart1_pins: pinmux_bb_uart1_pins {
+				pinctrl-single,pins = <
+					0x184 0x20 /* P9.24 uart1_txd.uart1_txd  OUTPUT  */
+					0x180 0x20 /* P9.26 uart1_rxd.uart1_rxd  INPUT  */
+				>;
+			};
+		};
+	};
+
+	fragment@1 {
+		target = <&ocp>;
+		__overlay__ {
+			/* avoid stupid warning */
+			#address-cells = <1>;
+			#size-cells = <1>;
+
+			tscadc {
+				compatible = "ti,ti-tscadc";
+				reg = <0x44e0d000 0x1000>;
+
+				interrupt-parent = <&intc>;
+				interrupts = <16>;
+				ti,hwmods = "adc_tsc";
+				status = "okay";
+
+				adc {
+					ti,adc-channels = <4 5 6>;
+				};
+			};
+		};
+	};
+
+	fragment@2 {
+		target = <&spi0>;	/* spi0 is numbered correctly */
+		__overlay__ {
+			#address-cells = <1>;
+			#size-cells = <0>;
+
+			status = "okay";
+			pinctrl-names = "default";
+			pinctrl-0 = <&bb_spi0_pins>;
+
+
+			channel@0 {
+				#address-cells = <1>;
+				#size-cells = <0>;
+
+				compatible = "spidev";
+
+				reg = <0>;
+				spi-max-frequency = <16000000>;
+				spi-cpha;
+			};
+
+
+			channel@1 {
+				#address-cells = <1>;
+				#size-cells = <0>;
+
+				compatible = "spidev";
+
+				reg = <1>;
+				spi-max-frequency = <16000000>;
+			};
+		};
+	};
+
+	fragment@3 {
+		target = <&uart2>;	/* really uart1 */
+		__overlay__ {
+			status = "okay";
+			pinctrl-names = "default";
+			pinctrl-0 = <&bb_uart1_pins>;
+		};
+	};
+};
-- 
1.8.5.3

